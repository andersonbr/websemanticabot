"use strict";
/**
 * Created by user on 2018/8/2/002.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const array_hyper_unique_1 = require("array-hyper-unique");
const UString = require("uni-string");
const cjk_conv_1 = require("regexp-helper/lib/cjk-conv");
function charMap(s, table) {
    let t = table[s];
    return (typeof t === 'string') ? t : s;
}
exports.charMap = charMap;
function textMap1(text, table) {
    let toText = [];
    let len = text.length;
    for (let i = 0; i < len; i++) {
        toText[i] = charMap(text[i], table);
    }
    //console.log(toText.length, toText);
    return toText.join('');
}
exports.textMap1 = textMap1;
function textMap2(text, table) {
    let toText = UString.split(text, '');
    let len = toText.length;
    for (let i = 0; i < len; i++) {
        toText[i] = charMap(toText[i], table);
    }
    //console.log(toText.length, toText);
    return toText.join('');
}
exports.textMap2 = textMap2;
function textMap3(text, table) {
    let toText = text.split(/(?:)/u);
    let len = toText.length;
    for (let i = 0; i < len; i++) {
        toText[i] = charMap(toText[i], table);
    }
    //console.log(toText.length, toText);
    return toText.join('');
}
exports.textMap3 = textMap3;
function textMap4(text, table) {
    return text.replace(exports.REGEXP_TEST, function (s) {
        return charMap(s, table);
    });
}
exports.textMap4 = textMap4;
exports.textMap = textMap4;
const textMap = textMap4;
exports.default = exports;
function removeSame(table) {
    return Object.entries(table)
        .reduce(function (a, b) {
        let [k, v] = b;
        if (k != v) {
            a[k] = v;
        }
        return a;
    }, {});
}
exports.removeSame = removeSame;
exports.defaultOptions = Object.freeze({
    safe: true,
});
exports.REGEXP_TEST = cjk_conv_1._re_cjk_conv('ug');
exports.SAFE_MODE_CHAR = array_hyper_unique_1.array_unique([
    '后',
    '里',
    '餵',
    '志',
    '布',
    '佈',
    '系',
    '繫',
    '梁',
    '樑',
    '衝',
    '沖',
    '谷',
    '穀',
    '注',
]);
function getOptionsSkip(options, skip = exports.SAFE_MODE_CHAR) {
    if (!options.skip) {
        options.skip = skip.slice();
    }
    else if (typeof options.skip == 'string') {
        options.skip += skip.join('');
    }
    else if (Array.isArray(options.skip)) {
        options.skip = options.skip.slice().concat(skip);
    }
    else {
        options.table = skip.reduce(function (a, b) {
            a[b] = b;
            return a;
        }, Object.assign({}, options.table || {}));
    }
    return options;
}
exports.getOptionsSkip = getOptionsSkip;
function getOptions(options = {}, defaultOpts = exports.defaultOptions, skip = exports.SAFE_MODE_CHAR) {
    options = Object.assign({}, defaultOpts, options);
    if (options.safe) {
        options = getOptionsSkip(options, skip);
        //console.log(options);
    }
    return options;
}
exports.getOptions = getOptions;
function _call(fn, text, options = {}, ...argv) {
    options = getOptions(options);
    if (options.skip || options.table || options.tableOnly) {
        let { skip, table, tableOnly } = options;
        let not_tableOnly = !tableOnly;
        if (tableOnly && !table) {
            throw new Error(`table is ${table}`);
        }
        return text.replace(exports.REGEXP_TEST, function (text) {
            if (skip && skip.indexOf(text) !== -1) {
                return text;
            }
            else if (table && typeof table == 'function') {
                let ret = table(fn, text, options, ...argv);
                if (ret !== null && typeof ret != 'undefined') {
                    return ret;
                }
            }
            else if (table && table[text]) {
                return table[text];
            }
            else if (not_tableOnly) {
                return fn(text);
            }
            return text;
        });
    }
    return fn(text, options, ...argv);
}
exports._call = _call;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILDJEQUFrRDtBQUdsRCxzQ0FBdUM7QUFDdkMseURBQTBEO0FBTzFELFNBQWdCLE9BQU8sQ0FBQyxDQUFTLEVBQUUsS0FBYTtJQUUvQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUN2QyxDQUFDO0FBSkQsMEJBSUM7QUFFRCxTQUFnQixRQUFRLENBQUMsSUFBWSxFQUFFLEtBQWE7SUFFbkQsSUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO0lBQ2hCLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFFdEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFDNUI7UUFDQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUNwQztJQUVELHFDQUFxQztJQUNyQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDdkIsQ0FBQztBQVpELDRCQVlDO0FBRUQsU0FBZ0IsUUFBUSxDQUFDLElBQVksRUFBRSxLQUFhO0lBRW5ELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3JDLElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFFeEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFDNUI7UUFDQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUN0QztJQUVELHFDQUFxQztJQUNyQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDeEIsQ0FBQztBQVpELDRCQVlDO0FBRUQsU0FBZ0IsUUFBUSxDQUFDLElBQVksRUFBRSxLQUFhO0lBRW5ELElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDakMsSUFBSSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUV4QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUM1QjtRQUNDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ3RDO0lBRUQscUNBQXFDO0lBQ3JDLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN4QixDQUFDO0FBWkQsNEJBWUM7QUFFRCxTQUFnQixRQUFRLENBQUMsSUFBWSxFQUFFLEtBQWE7SUFFbkQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFXLEVBQUUsVUFBVSxDQUFDO1FBRTNDLE9BQU8sT0FBTyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUMxQixDQUFDLENBQUMsQ0FBQztBQUNKLENBQUM7QUFORCw0QkFNQztBQUVvQiwyQkFBTztBQUM1QixNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUM7QUFFekIsa0JBQWUsT0FBa0MsQ0FBQztBQUVsRCxTQUFnQixVQUFVLENBQUMsS0FBYTtJQUV2QyxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1NBQzFCLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1FBRXJCLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWYsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUNWO1lBQ0MsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNUO1FBRUQsT0FBTyxDQUFDLENBQUM7SUFDVixDQUFDLEVBQUUsRUFBWSxDQUFDLENBQ2hCO0FBQ0YsQ0FBQztBQWZELGdDQWVDO0FBZ0JZLFFBQUEsY0FBYyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDM0MsSUFBSSxFQUFFLElBQUk7Q0FDVixDQUFDLENBQUM7QUFDVSxRQUFBLFdBQVcsR0FBRyx1QkFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRWpDLFFBQUEsY0FBYyxHQUFHLGlDQUFZLENBQUM7SUFDMUMsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0NBQ0gsQ0FBQyxDQUFDO0FBRUgsU0FBZ0IsY0FBYyxDQUFDLE9BQWlCLEVBQUUsSUFBSSxHQUFHLHNCQUFjO0lBRXRFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUNqQjtRQUNDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQzVCO1NBQ0ksSUFBSSxPQUFPLE9BQU8sQ0FBQyxJQUFJLElBQUksUUFBUSxFQUN4QztRQUNDLE9BQU8sQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUM5QjtTQUNJLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQ3BDO1FBQ0MsT0FBTyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNqRDtTQUVEO1FBQ0MsT0FBTyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7WUFFekMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVULE9BQU8sQ0FBQyxDQUFDO1FBQ1YsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztLQUMzQztJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUM7QUF6QkQsd0NBeUJDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLFVBQW9CLEVBQUUsRUFBRSxXQUFXLEdBQUcsc0JBQWMsRUFBRSxJQUFJLEdBQUcsc0JBQWM7SUFFckcsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUVsRCxJQUFJLE9BQU8sQ0FBQyxJQUFJLEVBQ2hCO1FBQ0MsT0FBTyxHQUFHLGNBQWMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFeEMsdUJBQXVCO0tBQ3ZCO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDaEIsQ0FBQztBQVpELGdDQVlDO0FBRUQsU0FBZ0IsS0FBSyxDQUFDLEVBQUUsRUFBRSxJQUFZLEVBQUUsVUFBb0IsRUFBRSxFQUFFLEdBQUcsSUFBSTtJQUV0RSxPQUFPLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTlCLElBQUksT0FBTyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsS0FBSyxJQUFJLE9BQU8sQ0FBQyxTQUFTLEVBQ3REO1FBQ0MsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEdBQUcsT0FBTyxDQUFDO1FBQ3pDLElBQUksYUFBYSxHQUFHLENBQUMsU0FBUyxDQUFDO1FBRS9CLElBQUksU0FBUyxJQUFJLENBQUMsS0FBSyxFQUN2QjtZQUNDLE1BQU0sSUFBSSxLQUFLLENBQUMsWUFBWSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1NBQ3JDO1FBRUQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFXLEVBQUUsVUFBVSxJQUFJO1lBRTlDLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQ3JDO2dCQUNDLE9BQU8sSUFBSSxDQUFDO2FBQ1o7aUJBQ0ksSUFBSSxLQUFLLElBQUksT0FBTyxLQUFLLElBQUksVUFBVSxFQUM1QztnQkFDQyxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztnQkFFNUMsSUFBSSxHQUFHLEtBQUssSUFBSSxJQUFJLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFDN0M7b0JBQ0MsT0FBTyxHQUFHLENBQUM7aUJBQ1g7YUFDRDtpQkFDSSxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQzdCO2dCQUNDLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ25CO2lCQUNJLElBQUksYUFBYSxFQUN0QjtnQkFDQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNoQjtZQUVELE9BQU8sSUFBSSxDQUFDO1FBQ2IsQ0FBQyxDQUFDLENBQUM7S0FDSDtJQUVELE9BQU8sRUFBRSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztBQUNuQyxDQUFDO0FBM0NELHNCQTJDQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvOC8yLzAwMi5cbiAqL1xuXG5pbXBvcnQgeyBhcnJheV91bmlxdWUgfSBmcm9tICdhcnJheS1oeXBlci11bmlxdWUnO1xuaW1wb3J0ICogYXMgX3RhYmxlX2NuMnR3IGZyb20gJ2NoaW5lc2VfY29udmVydC9jbjJ0dyc7XG5pbXBvcnQgKiBhcyBfdGFibGVfdHcyY24gZnJvbSAnY2hpbmVzZV9jb252ZXJ0L3R3MmNuJztcbmltcG9ydCBVU3RyaW5nID0gcmVxdWlyZSgndW5pLXN0cmluZycpO1xuaW1wb3J0IHsgX3JlX2Nqa19jb252IH0gZnJvbSAncmVnZXhwLWhlbHBlci9saWIvY2prLWNvbnYnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElUYWJsZVxue1xuXHRba2V5OiBzdHJpbmddOiBzdHJpbmcsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGFyTWFwKHM6IHN0cmluZywgdGFibGU6IElUYWJsZSlcbntcblx0bGV0IHQgPSB0YWJsZVtzXTtcblx0cmV0dXJuICh0eXBlb2YgdCA9PT0gJ3N0cmluZycpID8gdCA6IHNcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRleHRNYXAxKHRleHQ6IHN0cmluZywgdGFibGU6IElUYWJsZSlcbntcblx0bGV0IHRvVGV4dCA9IFtdO1xuXHRsZXQgbGVuID0gdGV4dC5sZW5ndGg7XG5cblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKylcblx0e1xuXHRcdHRvVGV4dFtpXSA9IGNoYXJNYXAodGV4dFtpXSwgdGFibGUpO1xuXHR9XG5cblx0Ly9jb25zb2xlLmxvZyh0b1RleHQubGVuZ3RoLCB0b1RleHQpO1xuXHRyZXR1cm4gdG9UZXh0LmpvaW4oJycpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0ZXh0TWFwMih0ZXh0OiBzdHJpbmcsIHRhYmxlOiBJVGFibGUpXG57XG5cdGxldCB0b1RleHQgPSBVU3RyaW5nLnNwbGl0KHRleHQsICcnKTtcblx0bGV0IGxlbiA9IHRvVGV4dC5sZW5ndGg7XG5cblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKylcblx0e1xuXHRcdHRvVGV4dFtpXSA9IGNoYXJNYXAodG9UZXh0W2ldLCB0YWJsZSk7XG5cdH1cblxuXHQvL2NvbnNvbGUubG9nKHRvVGV4dC5sZW5ndGgsIHRvVGV4dCk7XG5cdHJldHVybiB0b1RleHQuam9pbignJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0ZXh0TWFwMyh0ZXh0OiBzdHJpbmcsIHRhYmxlOiBJVGFibGUpXG57XG5cdGxldCB0b1RleHQgPSB0ZXh0LnNwbGl0KC8oPzopL3UpO1xuXHRsZXQgbGVuID0gdG9UZXh0Lmxlbmd0aDtcblxuXHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKVxuXHR7XG5cdFx0dG9UZXh0W2ldID0gY2hhck1hcCh0b1RleHRbaV0sIHRhYmxlKTtcblx0fVxuXG5cdC8vY29uc29sZS5sb2codG9UZXh0Lmxlbmd0aCwgdG9UZXh0KTtcblx0cmV0dXJuIHRvVGV4dC5qb2luKCcnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRleHRNYXA0KHRleHQ6IHN0cmluZywgdGFibGU6IElUYWJsZSlcbntcblx0cmV0dXJuIHRleHQucmVwbGFjZShSRUdFWFBfVEVTVCwgZnVuY3Rpb24gKHMpXG5cdHtcblx0XHRyZXR1cm4gY2hhck1hcChzLCB0YWJsZSk7XG5cdH0pO1xufVxuXG5leHBvcnQgeyB0ZXh0TWFwNCBhcyB0ZXh0TWFwIH1cbmNvbnN0IHRleHRNYXAgPSB0ZXh0TWFwNDtcblxuZXhwb3J0IGRlZmF1bHQgZXhwb3J0cyBhcyB0eXBlb2YgaW1wb3J0KCcuL2NvcmUnKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJlbW92ZVNhbWUodGFibGU6IElUYWJsZSlcbntcblx0cmV0dXJuIE9iamVjdC5lbnRyaWVzKHRhYmxlKVxuXHRcdC5yZWR1Y2UoZnVuY3Rpb24gKGEsIGIpXG5cdFx0e1xuXHRcdFx0bGV0IFtrLCB2XSA9IGI7XG5cblx0XHRcdGlmIChrICE9IHYpXG5cdFx0XHR7XG5cdFx0XHRcdGFba10gPSB2O1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gYTtcblx0XHR9LCB7fSBhcyBJVGFibGUpXG5cdDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJT3B0aW9uc1xue1xuXHQvKipcblx0ICog5b+955Wl55qE5a2XIG9yIOS7u+S9leaUr+aPtCBpbmRleE9mIOeahCBPYmplY3Rcblx0ICovXG5cdHNraXA/LFxuXG5cdHRhYmxlPzogSVRhYmxlIHwgdHlwZW9mIF9jYWxsLFxuXG5cdHNhZmU/OiBib29sZWFuLFxuXG5cdHRhYmxlT25seT86IGJvb2xlYW4sXG59XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0T3B0aW9ucyA9IE9iamVjdC5mcmVlemUoe1xuXHRzYWZlOiB0cnVlLFxufSk7XG5leHBvcnQgY29uc3QgUkVHRVhQX1RFU1QgPSBfcmVfY2prX2NvbnYoJ3VnJyk7XG5cbmV4cG9ydCBjb25zdCBTQUZFX01PREVfQ0hBUiA9IGFycmF5X3VuaXF1ZShbXG5cdCflkI4nLFxuXHQn6YeMJyxcblx0J+mktScsXG5cdCflv5cnLFxuXHQn5biDJyxcblx0J+S9iCcsXG5cdCfns7snLFxuXHQn57mrJyxcblx0J+aigScsXG5cdCfmqJEnLFxuXHQn6KGdJyxcblx0J+aylicsXG5cdCfosLcnLFxuXHQn56mAJyxcblx0J+azqCcsXG5dKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9wdGlvbnNTa2lwKG9wdGlvbnM6IElPcHRpb25zLCBza2lwID0gU0FGRV9NT0RFX0NIQVIpXG57XG5cdGlmICghb3B0aW9ucy5za2lwKVxuXHR7XG5cdFx0b3B0aW9ucy5za2lwID0gc2tpcC5zbGljZSgpO1xuXHR9XG5cdGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zLnNraXAgPT0gJ3N0cmluZycpXG5cdHtcblx0XHRvcHRpb25zLnNraXAgKz0gc2tpcC5qb2luKCcnKTtcblx0fVxuXHRlbHNlIGlmIChBcnJheS5pc0FycmF5KG9wdGlvbnMuc2tpcCkpXG5cdHtcblx0XHRvcHRpb25zLnNraXAgPSBvcHRpb25zLnNraXAuc2xpY2UoKS5jb25jYXQoc2tpcCk7XG5cdH1cblx0ZWxzZVxuXHR7XG5cdFx0b3B0aW9ucy50YWJsZSA9IHNraXAucmVkdWNlKGZ1bmN0aW9uIChhLCBiKVxuXHRcdHtcblx0XHRcdGFbYl0gPSBiO1xuXG5cdFx0XHRyZXR1cm4gYTtcblx0XHR9LCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zLnRhYmxlIHx8IHt9KSk7XG5cdH1cblxuXHRyZXR1cm4gb3B0aW9ucztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9wdGlvbnMob3B0aW9uczogSU9wdGlvbnMgPSB7fSwgZGVmYXVsdE9wdHMgPSBkZWZhdWx0T3B0aW9ucywgc2tpcCA9IFNBRkVfTU9ERV9DSEFSKVxue1xuXHRvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdE9wdHMsIG9wdGlvbnMpO1xuXG5cdGlmIChvcHRpb25zLnNhZmUpXG5cdHtcblx0XHRvcHRpb25zID0gZ2V0T3B0aW9uc1NraXAob3B0aW9ucywgc2tpcCk7XG5cblx0XHQvL2NvbnNvbGUubG9nKG9wdGlvbnMpO1xuXHR9XG5cblx0cmV0dXJuIG9wdGlvbnM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfY2FsbChmbiwgdGV4dDogc3RyaW5nLCBvcHRpb25zOiBJT3B0aW9ucyA9IHt9LCAuLi5hcmd2KVxue1xuXHRvcHRpb25zID0gZ2V0T3B0aW9ucyhvcHRpb25zKTtcblxuXHRpZiAob3B0aW9ucy5za2lwIHx8IG9wdGlvbnMudGFibGUgfHwgb3B0aW9ucy50YWJsZU9ubHkpXG5cdHtcblx0XHRsZXQgeyBza2lwLCB0YWJsZSwgdGFibGVPbmx5IH0gPSBvcHRpb25zO1xuXHRcdGxldCBub3RfdGFibGVPbmx5ID0gIXRhYmxlT25seTtcblxuXHRcdGlmICh0YWJsZU9ubHkgJiYgIXRhYmxlKVxuXHRcdHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgdGFibGUgaXMgJHt0YWJsZX1gKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGV4dC5yZXBsYWNlKFJFR0VYUF9URVNULCBmdW5jdGlvbiAodGV4dClcblx0XHR7XG5cdFx0XHRpZiAoc2tpcCAmJiBza2lwLmluZGV4T2YodGV4dCkgIT09IC0xKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gdGV4dDtcblx0XHRcdH1cblx0XHRcdGVsc2UgaWYgKHRhYmxlICYmIHR5cGVvZiB0YWJsZSA9PSAnZnVuY3Rpb24nKVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgcmV0ID0gdGFibGUoZm4sIHRleHQsIG9wdGlvbnMsIC4uLmFyZ3YpO1xuXG5cdFx0XHRcdGlmIChyZXQgIT09IG51bGwgJiYgdHlwZW9mIHJldCAhPSAndW5kZWZpbmVkJylcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJldHVybiByZXQ7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdGVsc2UgaWYgKHRhYmxlICYmIHRhYmxlW3RleHRdKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gdGFibGVbdGV4dF07XG5cdFx0XHR9XG5cdFx0XHRlbHNlIGlmIChub3RfdGFibGVPbmx5KVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gZm4odGV4dCk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB0ZXh0O1xuXHRcdH0pO1xuXHR9XG5cblx0cmV0dXJuIGZuKHRleHQsIG9wdGlvbnMsIC4uLmFyZ3YpO1xufVxuIl19